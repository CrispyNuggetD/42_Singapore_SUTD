# Set up the prompt

# 6 useful things here.

### (1) Includes two aliases 'compile' and 'run' so you don't have 
# to always type in full for 42-compliant compiling/ running
# You can also stack with valgrind flags.

# Usage:
# e.g. compile ft_isalpha.c
# e.g. compile ft_isalpha.c -o output (run with ./output)
# e.g. run ./output
# e.g. run ./output "Hello" 42 (Passing arguments)

# So, feel free to check with memory leaks with -g valgrind flag, i.e.:
# compile -g ft_isalpha.c

# You need to compile with library (behind .c file, order matters) if .a exists, i.e.:
# compile -g ft_isalpha.c libft.a -o output (run with ./output)

### (2) Three helper functions curproj() and syncproj().

# curproj switches into your github repo's project folder 
# and shows the last edit + last sync status.

# cdmain just goes into your github repo.

# syncgithub checks your working tree is clean, and 
# pulls from GitHub. It also pushes if you made changes.
# Run this first before working on another computer to prevent conflicts!
# NOTE: It does NOT touch Vogsphere. 
# SYNC your campus repo before submitting project!

# Usage: Just type curproj, cdmain, or syncproj into terminal.

# Notes:
# You MUST change a few things:

# 1. Change and point the project you're working
# on by changing variable, current_proj="<PROJECT NAME>"
# e.g. current_proj="0_libft"

# 2. Change PROJECTS_ROOTS to Project sub-folder in your repo,
# e.g. export PROJECTS_ROOTS="Core Curriculum/Projects"

# 3. Change MAIN_REPO_ROOT to your GitHub cloned repo on campus PC,
# e.g. export MAIN_REPO_ROOT="$HOME/Documents/42_Singapore_SUTD"

### (3) Zsh backwards cycling keybinds
# Technically Shift + Tab was supposed to work out of the box but
# it didn't for me so I just included it here.

###################################################################
### (APPEND THESE) Variables after changing and Functions       ###
### Do NOT replace original .zshrc file                         ###
###################################################################

# Set up the prompt

# 6 useful things here.

### (1) Includes two aliases 'compile' and 'run' so you don't have 
# to always type in full for 42-compliant compiling/ running
# with valgrind flags everytime.

# Usage:
# e.g. compile ft_isalpha.c
# e.g. compile ft_isalpha.c -o output (run with ./output)
# e.g. run ./output
# e.g. run ./output "Hello" 42 (Passing arguments)

### (2) Three helper functions curproj() and syncproj().

# curproj switches into your github repo's project folder 
# and shows the last edit + last sync status.

# cdmain just goes into your github repo.

# syncgithub checks your working tree is clean, and 
# pulls from GitHub. It also pushes if you made changes.
# Run this first before working on another computer to prevent conflicts!
# NOTE: It does NOT touch Vogsphere. 
# SYNC your campus repo before submitting project!

# Usage: Just type curproj, cdmain, or syncproj into terminal.

# Notes:
# hnah (intra) user defined
export MAIL='hnah@student.42singapore.sg'

# current project name (change as needed, then `source ~/.zshrc`)
export current_proj="0_libft"

# --- 42 paths ---
export PROJECTS_ROOT="Core Curriculum/Projects"
export MAIN_REPO_ROOT="$HOME/Documents/42_Singapore_SUTD"

# --- Zsh backwards cycling ---
bindkey "^[[Z" reverse-menu-complete
bindkey "^[Z" reverse-menu-complete

# compile helper
alias compile='cc -Wall -Wextra -Werror'

# Feel free to check with memory leaks with -g valgrind flag, i.e.
#compile -g

# code execution helper with valgrind and leak flags
alias run='valgrind --leak-check=full --show-leak-kinds=all'

# jump to current 42 project (Vogsphere working copy)
curproj() {
  local proj_dir="$MAIN_REPO_ROOT/$PROJECTS_ROOT/$current_proj"

  if [ ! -d "$proj_dir" ]; then
    echo "No such project directory: $proj_dir"
    return 1
  fi

  cd "$proj_dir" || return 1

  echo "Now working on: $current_proj"
  echo "Location: $proj_dir"

  # --- Last edit (in the 42/Vogsphere clone) ---
  if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Last local git activity (this 42 project):"
    git log -1 --pretty="  %h %s (%cr)"
  else
    echo "Not a git repo here (no .git found)."
  fi

  # --- Last sync to main GitHub repo ---
  if [ -d "$MAIN_REPO_ROOT/.git" ]; then
    # Get last commit in main repo that touched this project folder
    local last_sync_line
    last_sync_line=$(git -C "$MAIN_REPO_ROOT" log -1 \
      --pretty="%h %s (%cr)" \
      -- "Projects/$current_proj" 2>/dev/null)

    if [ -n "$last_sync_line" ]; then
      echo "Last sync to main repo (GitHub) for this project:"
      echo "  $last_sync_line"

      # Get last sync date in YYYY-MM-DD form
      local last_sync_date today yesterday
      last_sync_date=$(git -C "$MAIN_REPO_ROOT" log -1 \
        --date=short --pretty="%cd" \
        -- "Projects/$current_proj" 2>/dev/null)

      today=$(date +%Y-%m-%d)
      yesterday=$(date -d 'yesterday' +%Y-%m-%d)

      # Warn if last sync was not today or yesterday
      if [ "$last_sync_date" != "$today" ] && [ "$last_sync_date" != "$yesterday" ]; then
        echo "âš  WARNING: This project hasn't been synced to your main repo in more than a day."
      fi
    else# Set up the prompt

# 6 useful things here.

### (1) Includes two aliases 'compile' and 'run' so you don't have 
# to always type in full for 42-compliant compiling/ running
# with valgrind flags everytime.

# Usage:
# e.g. compile ft_isalpha.c
# e.g. compile ft_isalpha.c -o output (run with ./output)
# e.g. run ./output
# e.g. run ./output "Hello" 42 (Passing arguments)

### (2) Three helper functions curproj() and syncproj().

# curproj switches into your github repo's project folder 
# and shows the last edit + last sync status.

# cdmain just goes into your github repo.

# syncgithub checks your working tree is clean, and 
# pulls from GitHub. It also pushes if you made changes.
# Run this first before working on another computer to prevent conflicts!
# NOTE: It does NOT touch Vogsphere. 
# SYNC your campus repo before submitting project!

# Usage: Just type curproj, cdmain, or syncproj into terminal.

# Notes:
      echo "No sync found for this project in main repo yet."
    fi
  else
    echo "Main repo not found or not a git repo at: $MAIN_REPO_ROOT"
  fi
}

# jump to main GitHub repo
cdmain() {
  cd "$MAIN_REPO_ROOT" || {
    echo "No such main repo directory: $MAIN_REPO_ROOT"
    return 1
  }
} 

# sync current main GitHub repo: pull, then commit & push local changes
syncproj() {
  if [ -z "$MAIN_REPO_ROOT" ]; then
    echo "MAIN_REPO_ROOT is not set. Please set it in your .zshrc."
    return 1
  fi

  if [ ! -d "$MAIN_REPO_ROOT/.git" ]; then
    echo "No git repo found at: $MAIN_REPO_ROOT"
    return 1
  fi

  # jump into main repo
  cd "$MAIN_REPO_ROOT" || {
    echo "Failed to cd into $MAIN_REPO_ROOT"
    return 1
  }

  echo "Syncing main GitHub repo at:"
  echo "  $MAIN_REPO_ROOT"
  echo

  # 1) Always pull latest from GitHub first
  echo "Pulling from remote..."
  git pull
  echo

  # 2) Show current status
  echo "Current status:"
  git status
  echo

  # 3) If no changes, we're done
  if [[ -z "$(git status --porcelain)" ]]; then
    echo "No local changes to commit. Repo is up to date."
    return 0
  fi

  # 4) Stage everything (tracked + untracked + deletions)
  git add -A

  # show status so you see what will be committed
  echo
  echo "Changes staged for commit:"
  git status
  echo

  # 5) Ask for commit title/body (zsh style)
  read "title?Commit title (main repo): "
  read "body?Commit details (optional, leave blank if none): "

  if [[ -n "$body" ]]; then
    git commit -m "$title" -m "$body"
  else
    git commit -m "$title"
  fi

  # 6) Push to GitHub
  git push

  echo
  echo "Committed & pushed with message:"
  echo "--------------------------------"
  echo "$title"
  if [[ -n "$body" ]]; then
    echo
    echo "$body"
  fi
  echo "--------------------------------"
}   

